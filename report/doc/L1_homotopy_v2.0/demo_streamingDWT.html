<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of demo_streamingDWT</title>
  <meta name="keywords" content="demo_streamingDWT">
  <meta name="description" content="demo_streamingDWT">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- menu.html L1_homotopy_v2.0 -->
<h1>demo_streamingDWT
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>demo_streamingDWT</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> demo_streamingDWT

 Solves the following streaming problem
 min_a  \|a\|_1 + 1/2*||Phi Psi a + y||_2^2

 with Psi as an overlapping representation matrix and 
 by adding and removing one set of measurements at every time instant

 Applications:
           streaming signal recovery using (overlapping) DWT
           compare recovery using block-based DWT (sym=0) and
           overlapping DWT (sym = 3) near line 80
 We can also add any other regularization operator in the reconstruction

 Written by: Salman Asif, Georgia Tech
 Email: sasif@gatech.edu
 Created: March 2013

 TODO: this code needs some debugging (not stable)...</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="l1homotopy.html" class="code" title="function out = l1homotopy(A, y, opts)">l1homotopy</a>	l1homotopy.m</li><li><a href="../L1_homotopy_v2.0/solvers/SpaRSA_adpW.html" class="code" title="function [x,x_debias,objective,times,debias_start,mses,taus, numA, numAt]=SpaRSA_adpW(y,A,tau,varargin)">SpaRSA_adpW</a>	SpaRSA version 2.0, December 31, 2007</li><li><a href="../L1_homotopy_v2.0/solvers/soft.html" class="code" title="function y = soft(x,T)">soft</a>	</li><li><a href="../L1_homotopy_v2.0/solvers/yall1.html" class="code" title="function [x, Out] = yall1(A, b, opts)">yall1</a>	</li><li><a href="../L1_homotopy_v2.0/utils/fig.html" class="code" title="function h = fig(varargin)">fig</a>	</li><li><a href="../L1_homotopy_v2.0/utils/genAmat.html" class="code" title="function A = genAmat(M,N,in);">genAmat</a>	</li><li><a href="../L1_homotopy_v2.0/utils/genSignal.html" class="code" title="function [x varargout] = genSignal(N,in)">genSignal</a>	Inputs</li><li><a href="../L1_homotopy_v2.0/utils/utils_LOT/create_PHI.html" class="code" title="function PHI = create_PHI(in);">create_PHI</a>	Inputs</li><li><a href="../L1_homotopy_v2.0/utils/utils_Wavelet/apply_DWT.html" class="code" title="function alpha = apply_DWT(x,varargin)">apply_DWT</a>	Apply DWT on a streaming signal</li><li><a href="../L1_homotopy_v2.0/utils/utils_Wavelet/create_DWT.html" class="code" title="function Psi = create_DWT(in)">create_DWT</a>	Creates a DWT representation matrix without signal extension</li><li><a href="../L1_homotopy_v2.0/utils/utils_Wavelet/create_PSI_DWT.html" class="code" title="function PSI = create_PSI_DWT(in)">create_PSI_DWT</a>	Arrange DWT syntheis matrices over P overlapping windows (edges ignored)</li><li><a href="../L1_homotopy_v2.0/utils/utils_Wavelet/cshift.html" class="code" title="function y = cshift(x, t, dir)">cshift</a>	cshift.m</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% demo_streamingDWT</span>
0002 <span class="comment">%</span>
0003 <span class="comment">% Solves the following streaming problem</span>
0004 <span class="comment">% min_a  \|a\|_1 + 1/2*||Phi Psi a + y||_2^2</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% with Psi as an overlapping representation matrix and</span>
0007 <span class="comment">% by adding and removing one set of measurements at every time instant</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% Applications:</span>
0010 <span class="comment">%           streaming signal recovery using (overlapping) DWT</span>
0011 <span class="comment">%           compare recovery using block-based DWT (sym=0) and</span>
0012 <span class="comment">%           overlapping DWT (sym = 3) near line 80</span>
0013 <span class="comment">% We can also add any other regularization operator in the reconstruction</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Written by: Salman Asif, Georgia Tech</span>
0016 <span class="comment">% Email: sasif@gatech.edu</span>
0017 <span class="comment">% Created: March 2013</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% TODO: this code needs some debugging (not stable)...</span>
0020 
0021 clear
0022 close all force
0023  
0024 <span class="comment">% Limit the number of computational threads (for profiling)</span>
0025 <span class="comment">% maxNumCompThreads(1);</span>
0026 
0027 <span class="comment">%% Setup path</span>
0028 mname = mfilename;
0029 mpath = mfilename(<span class="string">'fullpath'</span>);
0030 mdir = mpath(1:end-length(mname));
0031 cd(mdir);
0032 
0033 addpath utils/
0034 addpath utils/utils_Wavelet
0035 addpath utils/utils_LOT
0036 addpath solvers/
0037 
0038 fprintf([<span class="string">'----------'</span>,datestr(now),<span class="string">'-------%s------------------\n'</span>],mname)
0039 
0040 <span class="comment">% load RandomStates</span>
0041 <span class="comment">%</span>
0042 rseed = 2013;
0043 rand(<span class="string">'state'</span>,rseed);
0044 randn(<span class="string">'state'</span>,rseed);
0045 
0046 <span class="comment">% simulation parameters</span>
0047 mType = <span class="string">'sign'</span>; <span class="comment">% {'randn','orth','rdct','streaming','subsample'};</span>
0048 sType = <span class="string">'pcwreg'</span>; <span class="comment">% % menu('Choose function:', 'heavisine', 'pcwpoly (N&gt;256,daub4)', 'pcwreg (N&gt;128,daub4)', 'doppler', ...);</span>
0049 SNR = 35;       <span class="comment">% additive Gaussian noise</span>
0050 
0051 <span class="comment">% system parameters</span>
0052 N = 256;   <span class="comment">% signal length</span>
0053 R = 4;      <span class="comment">% compression rate</span>
0054 M = round(N/R);    <span class="comment">% no. of measurements</span>
0055 
0056 LM = N; <span class="comment">% LM: length of measurement window</span>
0057 
0058 <span class="comment">% streaming window</span>
0059 P = 5; <span class="comment">% size of the working window is P*N</span>
0060 
0061 <span class="comment">% signal length</span>
0062 sig_length = 2^15; <span class="comment">% 128*128;</span>
0063 Np = N; <span class="comment">% interval of kalman-type signal evolution</span>
0064 
0065 <span class="comment">% signal extension for prediction of new coefficients in the streaming window.</span>
0066 eType = <span class="string">'per'</span>;
0067 
0068 <span class="comment">% signal dynamics</span>
0069 dType = <span class="string">'static'</span>; <span class="comment">% type of dynamics 'crshift', or 'static'</span>
0070 <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/cshift.html" class="code" title="function y = cshift(x, t, dir)">cshift</a> = -1;
0071 rshift_max = 0.5;
0072 rshift_h = @(z) (rand-0.5)*rshift_max*2;
0073 
0074 <span class="comment">% DWT parameters</span>
0075 <span class="comment">% type of scaling function</span>
0076 <span class="comment">% depth of scaling functions (number of wavelet levels)</span>
0077 <span class="comment">% type of extension for DWT (0 - periodic extension, 3 - streaming)</span>
0078 <span class="comment">%</span>
0079 <span class="comment">%-------------------------------------------------------------------------</span>
0080 <span class="comment">% COMPARE recovery using block DWT (sym=0) and overlapping DWT (sym = 3)</span>
0081 <span class="comment">%-------------------------------------------------------------------------</span>
0082 wType = <span class="string">'daub4'</span>; sym = 0;
0083 <span class="comment">% wType = 'daub4'; sym = 3;</span>
0084 J = log2(N)-3; 
0085 
0086 <span class="comment">% rank-1 update mode</span>
0087 delx_mode = <span class="string">'mil'</span>; <span class="comment">% mil or qr</span>
0088 
0089 <span class="comment">% add snapshots of the signal in streaming window and average them before comitting to the output.</span>
0090 avg_output = 0; 
0091  
0092 verbose = 0;
0093 
0094 
0095 <span class="comment">%% SM: Sampling modes</span>
0096 <span class="comment">% % LM: length of measurement window</span>
0097 <span class="comment">% LM = 2*N; % 'universal' sampling scheme (align before the overlapping regions of DWT windows that are measured)</span>
0098 <span class="keyword">if</span> LM &gt; N
0099     LeftEdge_trunc = 1;
0100 <span class="keyword">else</span>
0101     LeftEdge_trunc = 0;
0102 <span class="keyword">end</span>
0103 LeftProj_cancel = 1;
0104 
0105 fprintf(<span class="string">'Streaming signal measureed and reconstructed with overlapping windows using DWT ... \n'</span>);
0106 str0 = sprintf(<span class="string">'mType-%s, sType-%s, SNR = %d, (N,M,R) = %d, %d, %d, P = %d, LM = %d, \n wType-%s, J = %d, sym = %d, specified signal-length = %d, \n dType-%s, cshift = %d, rshift_max = %3.4g, Np = %d.'</span>, mType, sType, SNR, N, round(N/R), R, P, LM, wType, J, sym, sig_length, dType, <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/cshift.html" class="code" title="function y = cshift(x, t, dir)">cshift</a>, rshift_max, Np);
0107 disp(str0);
0108 
0109 <span class="comment">%% DWT setup</span>
0110 <span class="comment">% DWT parameters</span>
0111 <span class="comment">% Length of each window is L. (extend to adaptive/dyadic windows later?)</span>
0112 <span class="comment">% wType = 'daub4'; % type of scaling function</span>
0113 <span class="comment">% J = 3; % depth of scaling functions (number of wavelet levels)</span>
0114 <span class="comment">% sym = 3; % type of extension for DWT (0 - periodic extension, 3 - streaming)</span>
0115 
0116 in_Psi = []; in_Psi.N = N; in_Psi.J = J; in_Psi.wType = wType; in_Psi.sym = sym;
0117 Psi = <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/create_DWT.html" class="code" title="function Psi = create_DWT(in)">create_DWT</a>(in_Psi); <span class="comment">% DWT synthesis matrix over a window</span>
0118 L = size(Psi,1);
0119 
0120 <span class="comment">%% Signal generation</span>
0121 
0122 <span class="comment">% Setup dynamical model</span>
0123 <span class="comment">% At every time instance, add to the original/previous signal</span>
0124 <span class="comment">% an integer circular shift that is known</span>
0125 <span class="comment">% a random drift that is unknown</span>
0126 <span class="keyword">if</span> strcmpi(dType,<span class="string">'crshift'</span>)    
0127     <span class="comment">% Generate a random signal</span>
0128     in = []; in.type = sType; in.randgen = 0; in.take_fwt = 0; 
0129     [x_init sig wave_struct] = <a href="../L1_homotopy_v2.0/utils/genSignal.html" class="code" title="function [x varargout] = genSignal(N,in)">genSignal</a>(N,in);
0130     
0131     F_h = @(x,<a href="../L1_homotopy_v2.0/utils/utils_Wavelet/cshift.html" class="code" title="function y = cshift(x, t, dir)">cshift</a>,rshift) interp1(1:N,circshift(x,<a href="../L1_homotopy_v2.0/utils/utils_Wavelet/cshift.html" class="code" title="function y = cshift(x, t, dir)">cshift</a>),[1:N]+rshift,<span class="string">'linear'</span>,<span class="string">'extrap'</span>)';
0132     
0133     F0 = zeros(N);
0134     <span class="keyword">for</span> ii = 1:Np;
0135         F0(:,ii) = F_h(circshift([1; zeros(N-1,1)],ii-1),<a href="../L1_homotopy_v2.0/utils/utils_Wavelet/cshift.html" class="code" title="function y = cshift(x, t, dir)">cshift</a>,0);
0136     <span class="keyword">end</span>
0137     maxsim = round(sig_length)/N;
0138     sigt = sig; sig = [];
0139     <span class="keyword">for</span> ii = 1:maxsim;
0140         rshift = rshift_h(1);
0141         sigt = F_h(sigt, <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/cshift.html" class="code" title="function y = cshift(x, t, dir)">cshift</a>, rshift);
0142         sig = [sig; sigt];
0143     <span class="keyword">end</span>
0144 <span class="keyword">else</span>
0145     <span class="comment">% Generate a random signal</span>
0146     in = []; in.type = sType; in.randgen = 0; in.take_fwt = 0; in.Np = Np;
0147     [x_init sig wave_struct] = <a href="../L1_homotopy_v2.0/utils/genSignal.html" class="code" title="function [x varargout] = genSignal(N,in)">genSignal</a>(sig_length,in);
0148 <span class="keyword">end</span>
0149 sig = [zeros(L-N,1); sig]; 
0150 sig_length = length(sig);
0151  
0152 <span class="comment">% view DWT coefficients...</span>
0153 alpha_vec = <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/apply_DWT.html" class="code" title="function alpha = apply_DWT(x,varargin)">apply_DWT</a>(sig,N,wType,J,sym);
0154 figure(123); 
0155 subplot(211); imagesc(reshape(alpha_vec,N,length(alpha_vec)/N)); 
0156 axis xy;
0157 subplot(212); plot(alpha_vec); 
0158  
0159 
0160 <span class="comment">%% Save results..</span>
0161 streaming_iter = ceil(length(sig)/N);
0162 SIM_stack = cell(streaming_iter,1);
0163 SIM_memory = cell(streaming_iter,1);
0164 
0165 x_vec = zeros(N*streaming_iter,1);
0166 xh_vec = zeros(N*streaming_iter,3);
0167 sig_vec = zeros(length(sig),1);
0168 sigh_vec = zeros(length(sig),3);
0169 
0170 <span class="comment">%% Create analysis/synthesis matrix explicitly</span>
0171 in = [];
0172 in.P = P; in.Psi = Psi;
0173 <span class="comment">% in.P = P; in.Jp = Jp; in.wType = wType; in.Np = Np; in.sym = sym;</span>
0174 PSI = <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/create_PSI_DWT.html" class="code" title="function PSI = create_PSI_DWT(in)">create_PSI_DWT</a>(in);
0175 
0176 <span class="comment">%% Setup sensing matrices</span>
0177 in = []; in.type = mType; in.parts = 4;
0178 genAmat_h = @(M,N) <a href="../L1_homotopy_v2.0/utils/genAmat.html" class="code" title="function A = genAmat(M,N,in);">genAmat</a>(M,LM,in);
0179 in.P = P-(LM-N)/N;
0180 in.LM = LM; in.M = M; in.N = N;
0181 PHI = <a href="../L1_homotopy_v2.0/utils/utils_LOT/create_PHI.html" class="code" title="function PHI = create_PHI(in);">create_PHI</a>(in);
0182 
0183 <span class="comment">%% Overall streaming system matrix</span>
0184 T_length = size(PSI,1);
0185 t_ind = 1:T_length;
0186 
0187 sigt = sig(t_ind); <span class="comment">% Signal under the LOT window at time t</span>
0188 <span class="keyword">if</span> sym == 1 || sym == 2
0189     x = pinv(PSI'*PSI)*(PSI'*sigt); <span class="comment">% Sparse LOT coefficients</span>
0190 <span class="keyword">else</span>
0191     x = PSI'*sigt;
0192 <span class="keyword">end</span>
0193 
0194 PSI_M = PSI(1:end-(L-N),:);
0195 A = PHI*PSI_M;
0196 y = PHI*sigt(1:end-(L-N));
0197 
0198 leny = length(y);
0199 sigma = sqrt(norm(y)^2/10^(SNR/10)/leny);
0200 e = randn(leny,1)*sigma;
0201 y = y+e;
0202 
0203 <span class="comment">% parameter selection</span>
0204 <span class="comment">% tau = sigma*sqrt(log(N));</span>
0205 tau = max(1e-2*max(abs(A'*y)),sigma*sqrt(log(P*N)));
0206 
0207 maxiter = 2*P*N;
0208 err_fun = @(z) (norm(x-z)/norm(x))^2;
0209 
0210 <span class="comment">%% Initialize by solving a rwt L1 problem</span>
0211 in = [];
0212 in.tau = tau; W = tau;
0213 in.W = W;
0214 in.delx_mode = delx_mode;
0215 in.debias = 0;
0216 in.verbose = 0;
0217 in.plots = 0;
0218 in.record = 1;
0219 in.err_fun = err_fun;
0220 tic
0221 <span class="keyword">for</span> wt_itr = 1:5
0222     
0223     out = <a href="l1homotopy.html" class="code" title="function out = l1homotopy(A, y, opts)">l1homotopy</a>(A,y,in);
0224     xh = out.x_out;
0225     iter_bpdn = out.iter;
0226     time_bpdn = toc;
0227     gamma_bpdn = out.gamma;
0228     
0229     <span class="comment">% Update weights</span>
0230     xh_old = xh;
0231     
0232     alpha = 1; epsilon = 1;
0233     beta = M*(norm(xh,2)/norm(xh,1))^2;
0234     W = tau/alpha./(beta*abs(xh)+epsilon);
0235     
0236     W_old = W;
0237     yh = A*xh;     
0238     Atr = A'*(A*xh-y);
0239     u =  -W.*sign(xh)-Atr;
0240     pk_old = Atr+u;
0241     
0242     in = out;
0243     in.xh_old = xh;
0244     in.pk_old = pk_old;
0245     in.u = u;
0246     in.W_old = W_old;
0247     in.W = W;
0248 <span class="keyword">end</span>
0249 W = W_old;
0250 
0251 sim = 1;
0252 x_vec((sim-1)*N+1:sim*N,1) = x(1:N);
0253 xh_vec((sim-1)*N+1:sim*N,1:3) = [xh(1:N) xh(1:N) xh(1:N)]; 
0254 
0255 s_ind = 1:L;
0256 sig_temp = Psi*xh(1:N);
0257 s_offset = 0;
0258 
0259 sig_vec(s_ind) = sigt(s_ind);
0260 sigh_vec(s_ind,1:3) = sigh_vec(s_ind,1:3)+[sig_temp sig_temp sig_temp];
0261 
0262 <span class="comment">% average instantaneous estimates before committing to output...</span>
0263 estimate_buffer = repmat(xh(1:(P-1)*N,1),1,P-1)/(P-1);
0264 
0265 xh_streamingRWT = xh;
0266 x_sparsa = xh;
0267 x_yall1 = xh;
0268 
0269 done = 0;
0270 <span class="keyword">while</span> ~done
0271      
0272     <span class="comment">%% Update the solution after updating the measurement matrix and/or the</span>
0273     <span class="comment">% sparse signal</span>
0274     y_old = y; x_old = x;
0275     
0276     sigt_old = sigt; t_ind_old = t_ind;
0277     PHI_old = PHI; 
0278     
0279     <span class="comment">% Shift the sampling window</span>
0280     t_ind = t_ind+N;
0281     <span class="keyword">if</span> t_ind(end) &gt; length(sig)
0282         <span class="keyword">break</span>;
0283     <span class="keyword">end</span>
0284     sigt = sig(t_ind);
0285     
0286     <span class="comment">% System matrix setup...</span>
0287     <span class="comment">% Shift up and left</span>
0288     PHI(1:end-M,1:end-N) = PHI(M+1:<span class="keyword">end</span>,N+1:end);
0289     <span class="comment">% new measurement matrix</span>
0290     Phi = genAmat_h(M,LM);
0291     PHI(end-M+1:<span class="keyword">end</span>,end-LM+1:end) = Phi;
0292     
0293     
0294     A = PHI*PSI_M;
0295     y = PHI*sigt(1:end-(L-N));
0296     
0297     <span class="comment">% Sparse LOT coeffs. irrespective of SM</span>
0298     <span class="keyword">if</span> sym == 1 || sym == 2
0299         x = pinv(PSI'*PSI)*(PSI'*sigt);
0300     <span class="keyword">else</span>
0301         x = PSI'*sigt;
0302     <span class="keyword">end</span>
0303     
0304     <span class="comment">% shift old measurements and add one new set of measurementts</span>
0305     e(1:end-M) = e(M+1:end);
0306     e(end-M+1:end) = randn(M,1)*sigma;
0307     y= y+e;
0308     
0309     A0 = A; x0 = x; y0 = y;
0310     <span class="keyword">for</span> solver = {<span class="string">'l1homotopy'</span>,<span class="string">'sparsa'</span>,<span class="string">'yall1'</span>}
0311         solver = char(solver);
0312         <span class="keyword">switch</span> solver
0313             <span class="keyword">case</span> <span class="string">'l1homotopy'</span>
0314                 xh = xh_streamingRWT;
0315             <span class="keyword">case</span> <span class="string">'sparsa'</span>
0316                 xh = x_sparsa;
0317             <span class="keyword">case</span> <span class="string">'yall1'</span>
0318                 xh = x_yall1;
0319         <span class="keyword">end</span>
0320         y = y0; A = A0; x = x0;
0321         xh_old = xh;
0322         
0323           
0324         <span class="comment">% REMOVE the part of outgoing DWT projection in the overlapping region</span>
0325         <span class="comment">% on left side of streaming window...</span>
0326         <span class="keyword">if</span> LeftProj_cancel
0327             y(1:M) = y(1:M)-PHI(1:M,1:(L-N))*(Psi(end-(L-N)+1:<span class="keyword">end</span>,:)*xh_old(1:N));
0328         <span class="keyword">end</span>
0329         
0330         <span class="comment">%% Update the signal estimate (for warm start)</span>
0331         xh(1:end-N) = xh(N+1:end);
0332         <span class="comment">% truncate small values in xh</span>
0333         <span class="comment">% xh(abs(xh)&lt;tau/sqrt(log(P*N))) = 0;</span>
0334         
0335         <span class="comment">% --------------------------------------------%</span>
0336         <span class="comment">%  Linear prediction for the incoming samples %</span>
0337         <span class="comment">% --------------------------------------------%</span>
0338         <span class="comment">%</span>
0339         <span class="comment">%         xh1 = xh(end-N+1:end);</span>
0340         <span class="comment">%</span>
0341         <span class="comment">%         if strcmpi(eType,'per')</span>
0342         <span class="comment">%             % periodic extension</span>
0343         <span class="comment">%             xh1 = xh(end-N+1:end);</span>
0344         <span class="comment">%         else</span>
0345         <span class="comment">%             sig_temp = PSI_M(1:end-N,1:(P-1)*N)*xh(1:end-N);</span>
0346         <span class="comment">%             sig_temp(1:L-N) = sig_temp(1:L-N)+Psi(end-(L-N)+1:end,:)*xh_old(1:N);</span>
0347         <span class="comment">%             % if sim == 1</span>
0348         <span class="comment">%             %     fprintf('Extension type: %s \n',eType);</span>
0349         <span class="comment">%             % end</span>
0350         <span class="comment">%             switch eType</span>
0351         <span class="comment">%                 case 'asym'</span>
0352         <span class="comment">%                     % anti-symmetric extension</span>
0353         <span class="comment">%                     sig_temp2 = [sig_temp; -sig_temp(end:-1:1); sig_temp];</span>
0354         <span class="comment">%                 case 'sym'</span>
0355         <span class="comment">%                     % symmetrci extension</span>
0356         <span class="comment">%                     sig_temp2 = [sig_temp; sig_temp(end:-1:1); sig_temp];</span>
0357         <span class="comment">%                 otherwise</span>
0358         <span class="comment">%                     disp('cant do it sire');</span>
0359         <span class="comment">%             end</span>
0360         <span class="comment">%             sig_temp2 = sig_temp2(1:size(PSI,1));</span>
0361         <span class="comment">%             if sym == 1 || sym == 2</span>
0362         <span class="comment">%                 xh_temp = pinv(PSI'*PSI)*(PSI'*sig_temp2);</span>
0363         <span class="comment">%             else</span>
0364         <span class="comment">%                 xh_temp = PSI'*sig_temp2;</span>
0365         <span class="comment">%             end</span>
0366         <span class="comment">%             xh1 = xh_temp(end-N+1:end);</span>
0367         <span class="comment">%         end</span>
0368         <span class="comment">%</span>
0369         <span class="comment">%         gamma1 = find(abs(xh1)&gt;tau);</span>
0370         <span class="comment">%         [val ind] = sort(abs(xh1),'descend');</span>
0371         <span class="comment">%         gamma1 = ind(1:min(length(gamma1),ceil(M/log2(N))));</span>
0372         <span class="comment">%</span>
0373         <span class="comment">%         yt = y(end-M+1:end)-A(end-M+1:end,1:end-N)*xh(1:end-N);</span>
0374         <span class="comment">%         At = A(end-M+1:end,end-N+1:end);</span>
0375         <span class="comment">%         gamma3 = gamma1;</span>
0376         <span class="comment">%         %</span>
0377         <span class="comment">%         % NOTE TODO: Need to replace prediction with rank-update...</span>
0378         <span class="comment">%         %</span>
0379         <span class="comment">%         % gamma_all = [find(xh(1:end-N)); gamma3+(P-1)*N];</span>
0380         <span class="comment">%         % xh_all = 0*xh;</span>
0381         <span class="comment">%         % xh_all(gamma_all) = A(:,gamma_all)\y; % pinv(A(:,gamma_all)'*A(:,gamma_all))*(A(:,gamma_all)'*y-W(gamma_all).*sign(xh(gamma_all)));</span>
0382         <span class="comment">%</span>
0383         <span class="comment">%         % if SM == 3</span>
0384         <span class="comment">%         %     Aty = At'*yt;</span>
0385         <span class="comment">%         %     [val ind] = sort(abs(Aty),'descend');</span>
0386         <span class="comment">%         %     gamma2 = ind(1:min(length(gamma1),ceil(M/4)));</span>
0387         <span class="comment">%         %     gamma3 = union(gamma1,gamma2);</span>
0388         <span class="comment">%         % end</span>
0389         <span class="comment">%         %</span>
0390         <span class="comment">%         xh_t1 = 0*xh(end-N+1:end);</span>
0391         <span class="comment">%         xh_t1(gamma3) = pinv(At(:,gamma3)'*At(:,gamma3)+2*tau*eye(length(gamma3)))*(At(:,gamma3)'*yt);</span>
0392         <span class="comment">%         xh_t1(abs(xh_t1)&lt;tau/sqrt(log(P*N))) = 0;</span>
0393         <span class="comment">%         xh(end-N+1:end) = xh_t1;</span>
0394         
0395         
0396         <span class="comment">% Truncate small coefficients... ?</span>
0397         xh(abs(xh)&lt;tau/sqrt(log(P*N))) = 0;
0398         <a href="../L1_homotopy_v2.0/utils/fig.html" class="code" title="function h = fig(varargin)">fig</a>(111);
0399         plot([x xh]);
0400         
0401         <span class="comment">% Remove the top-left edge of the system matrix</span>
0402         <span class="keyword">if</span> LeftEdge_trunc
0403             <span class="comment">% fprintf('Consider oldest set of LOT coefficients to be fully known, and remove their contribution from the measurements... \n');</span>
0404             alpha0h = xh(1:N);
0405             xh = xh(N+1:end);
0406             y = y-A(:,1:N)*alpha0h;
0407             
0408             A = A(:,N+1:end);
0409             alpha0 = x(1:N);
0410             x = x(N+1:end);
0411         <span class="keyword">end</span>
0412         
0413         <span class="comment">% Update weights</span>
0414         epsilon = 1;
0415         beta = max(epsilon,M*(norm(xh,2)/norm(xh,1))^1);
0416         W = tau/alpha./(beta*abs(xh)+epsilon);
0417         
0418         W_old = W;
0419         
0420         
0421         <span class="keyword">if</span> strcmpi(solver,<span class="string">'l1homotopy'</span>)
0422             
0423             homotopy_mode = <span class="string">'dummy'</span>;
0424             <span class="keyword">switch</span> homotopy_mode
0425                 <span class="keyword">case</span> <span class="string">'dummy'</span>
0426                     <span class="comment">% create a dummy variable...</span>
0427                     <span class="comment">% use homotopy on the measurements...</span>
0428                     <span class="comment">% in principle, we can start with any xh with this formulation</span>
0429                     <span class="comment">% and any starting value of tau or W...</span>
0430                     gamma = find(xh);
0431                     M_trunc = size(A,1); <span class="comment">% P*(M-1);</span>
0432                     <span class="comment">% M_trunc = round(P*(N-1)/5);</span>
0433                     <span class="keyword">if</span> length(gamma) &gt;= M_trunc
0434                         disp(<span class="string">'length of gamma exceeded number of rows'</span>);
0435                         [xh_sort ind_sort] = sort(abs(xh),<span class="string">'descend'</span>);
0436                         xh(ind_sort(M_trunc+1:end)) = 0;
0437                         gamma = ind_sort(1:M_trunc);
0438                     <span class="keyword">end</span>
0439                     Atr = A'*(A*xh-y);
0440                     u =  -W.*sign(xh)-Atr;
0441                     pk_old = Atr+u;
0442                 <span class="keyword">otherwise</span>
0443                     didp(<span class="string">'Go back ... no escape'</span>);
0444             <span class="keyword">end</span>
0445             
0446             
0447             in = out;
0448             gamma_old = gamma;
0449             in.gamma = gamma_old;
0450             <span class="keyword">switch</span> delx_mode
0451                 <span class="keyword">case</span> <span class="string">'mil'</span>;
0452                     <span class="comment">% in.delx_mode = 'mil';</span>
0453                     <span class="comment">% The following gram matrix and its inverse can be used from the</span>
0454                     <span class="comment">% previous homotopy. Too lazy to include that right now...</span>
0455                     <span class="comment">% wt BPDN homotopy update</span>
0456                     AtAgx = A(:,gamma_old)'*A(:,gamma_old);
0457                     iAtAgx = pinv(AtAgx);
0458                     in.iAtA = iAtAgx;
0459                 <span class="keyword">case</span> {<span class="string">'qr'</span>,<span class="string">'chol'</span>};
0460                     <span class="comment">% in.delx_mode = 'qr';</span>
0461                     [Q R] = qr(A(:,gamma_old),0);
0462                     in.Q = Q; in.R = R;
0463                 <span class="keyword">case</span> <span class="string">'qrM'</span>
0464                     <span class="comment">% in.delx_mode = 'qrM';</span>
0465                     [Q0 R0] = qr(A(:,gamma_old));
0466                     in.Q0 = Q0; in.R0 = R0;
0467             <span class="keyword">end</span>
0468             
0469             in.xh_old = xh;
0470             in.pk_old = pk_old;
0471             in.u = u;
0472             in.W = W;
0473             in.delx_mode = delx_mode;
0474             in.debias = 0;
0475             in.verbose = 0;
0476             in.plots = 0;
0477             in.record = 1;
0478             in.err_fun = @(z) (norm(x-z)/norm(x))^2;
0479             tic
0480             out = <a href="l1homotopy.html" class="code" title="function out = l1homotopy(A, y, opts)">l1homotopy</a>(A,y,in);
0481             time_streamingRWT = toc;
0482             xh_streamingRWT = out.x_out;
0483             gamma_streamingRWT = out.gamma;
0484             iter_streamingRWT = out.iter;
0485             <span class="comment">% Reconstructed signal</span>
0486             <span class="keyword">if</span> LeftEdge_trunc
0487                 x = [alpha0; x];
0488                 xh_streamingRWT = [alpha0h; xh_streamingRWT];
0489             <span class="keyword">end</span>         
0490         <span class="keyword">elseif</span>  strcmpi(solver,<span class="string">'sparsa'</span>)
0491             <span class="comment">%% SpaRSA</span>
0492             x_sparsa = xh; W_sparsa = W/tau; iter_sparsa = 0; time_sparsa = 0;
0493             <span class="keyword">if</span> norm(y) &gt; 1e-3
0494                 psi_function = @(x,tau) <a href="../L1_homotopy_v2.0/solvers/soft.html" class="code" title="function y = soft(x,T)">soft</a>(x,tau*W_sparsa);
0495                 phi_function = @(x) sum(abs(W_sparsa.*x));
0496                 tic;
0497                 [x_sparsa,x_debias_SpaRSA_m,obj_SpaRSA_m_cont,<span class="keyword">...</span>
0498                     times_SpaRSA_m_cont,debias_start_SpaRSA_m,mse_SpaRSA_m,taus_SpaRSA_m, numA, numAt]= <span class="keyword">...</span>
0499                     <a href="../L1_homotopy_v2.0/solvers/SpaRSA_adpW.html" class="code" title="function [x,x_debias,objective,times,debias_start,mses,taus, numA, numAt]=SpaRSA_adpW(y,A,tau,varargin)">SpaRSA_adpW</a>(y,A,tau,<span class="keyword">...</span>
0500                     <span class="string">'Monotone'</span>,0,<span class="keyword">...</span>
0501                     <span class="string">'adp_wt'</span>,0,<span class="keyword">...</span>
0502                     <span class="string">'W_new'</span>,W_sparsa,<span class="keyword">...</span>
0503                     <span class="string">'Debias'</span>,0,<span class="keyword">...</span>
0504                     <span class="string">'Initialization'</span>,x_sparsa,<span class="keyword">...</span>
0505                     <span class="string">'StopCriterion'</span>,2,<span class="keyword">...</span>
0506                     <span class="string">'ToleranceA'</span>,1e-4,<span class="keyword">...</span>
0507                     <span class="string">'psi'</span>,psi_function,<span class="keyword">...</span>
0508                     <span class="string">'phi'</span>,phi_function,<span class="keyword">...</span>
0509                     <span class="string">'Safeguard'</span>,1,<span class="keyword">...</span>
0510                     <span class="string">'MaxiterA'</span>,maxiter,<span class="keyword">...</span>
0511                     <span class="string">'Verbose'</span>,0,<span class="keyword">...</span>
0512                     <span class="string">'True_x'</span>,x,<span class="keyword">...</span>
0513                     <span class="string">'Continuation'</span>,1,<span class="keyword">...</span>
0514                     <span class="string">'Continuationsteps'</span>,-1);
0515                 
0516                 time_sparsa = toc;
0517                 iter_sparsa = (numA+numAt)/2;
0518                 error_sparsa = norm(x-x_sparsa)/norm(x);            
0519             <span class="keyword">end</span>
0520             <span class="comment">% Reconstructed signal</span>
0521             <span class="keyword">if</span> LeftEdge_trunc
0522                 x = [alpha0; x];
0523                 x_sparsa = [alpha0h; x_sparsa];
0524             <span class="keyword">end</span>
0525         <span class="keyword">elseif</span> strcmpi(solver,<span class="string">'yall1'</span>)            
0526             
0527             <span class="comment">%% YALL1</span>
0528             <span class="comment">% set options</span>
0529             digit = 4; <span class="keyword">if</span> sigma &gt; 0; digit = 4; <span class="keyword">end</span>
0530             opts = [];
0531             opts.tol = 10^(-digit);
0532             opts.weights = W/tau;
0533             opts.print = 0;
0534             opts.maxit = maxiter;
0535             opts.nonorth = 1;
0536             <span class="comment">% opts.x0 = xh;</span>
0537             opts.nu = 0; opts.rho = tau;
0538             tic;
0539             [x_yall1,Out_yall1] = <a href="../L1_homotopy_v2.0/solvers/yall1.html" class="code" title="function [x, Out] = yall1(A, b, opts)">yall1</a>(A,y,opts);
0540             <span class="comment">% time_yall1 = [time_yall1 Out.cputime];</span>
0541             time_yall1 = toc;
0542             iter_yall1 = (Out_yall1.cntA+Out_yall1.cntAt)/2;
0543             err_yall1 = norm(x-x_yall1)/norm(x);
0544             <span class="comment">% Reconstructed signal</span>
0545             <span class="keyword">if</span> LeftEdge_trunc
0546                 x = [alpha0; x];
0547                 x_yall1 = [alpha0h; x_yall1];
0548             <span class="keyword">end</span>         
0549             
0550             <span class="keyword">if</span> max(abs(x_yall1)) &gt; 500
0551                 stp = 1;
0552             <span class="keyword">end</span>
0553         <span class="keyword">end</span> 
0554     <span class="keyword">end</span>
0555     <span class="comment">%% Record results</span>
0556     sim = sim+1;
0557     SIM_stack{sim} = [sim, tau, <span class="keyword">...</span>
0558         norm(x-xh_streamingRWT)^2/norm(x)^2, sum(iter_streamingRWT,2), sum(time_streamingRWT,2), <span class="keyword">...</span>
0559         norm(x-x_sparsa)^2/norm(x)^2, sum(iter_sparsa,2), sum(time_sparsa,2), <span class="keyword">...</span>
0560         norm(x-x_yall1)^2/norm(x)^2, sum(iter_yall1,2), sum(time_yall1,2)];
0561     
0562     <span class="comment">% print and plot</span>
0563     <span class="keyword">if</span> mod(sim-1,verbose) == 0 &amp;&amp; verbose
0564         fprintf(<span class="string">'streaming iter. %d. tau = %3.4g, (err,iter,time): streamingRWT homotopy-%3.4g,%3.4g,%3.4g, SpaRSA-%3.4g,%3.4g,%3.4g, YALL1-%3.4g,%3.4g,%3.4g. \n'</span>, <span class="keyword">...</span>
0565             SIM_stack{sim});
0566     <span class="keyword">end</span>
0567     
0568     <span class="comment">%% Plot DWT coeffs. on the window</span>
0569     <a href="../L1_homotopy_v2.0/utils/fig.html" class="code" title="function h = fig(varargin)">fig</a>(1); subplot(211);
0570     plot([x xh_streamingRWT x_sparsa x_yall1]);
0571     title(<span class="string">'Comparison betweeen the original and reconstructed signal'</span>)
0572     
0573     <span class="comment">%% Reconstructed signal</span>
0574     x_vec((sim-1)*N+1:sim*N,1) = x(1:N);
0575     xh = xh_streamingRWT;
0576     
0577     <span class="comment">% remove the oldest estimate, shift the remaining up and left, and add the new estimate</span>
0578     estimate_buffer = [[estimate_buffer(N+1:<span class="keyword">end</span>,2:end); zeros(N,P-2)] xh(1:end-N)/(P-1)];
0579     <span class="keyword">if</span> avg_output 
0580         xh_est = xh(1:N);
0581         xh(1:N) = sum(estimate_buffer(1:N,:),2);
0582         <span class="comment">% fig(123); plot([xh_est xh(1:N) x(1:N)])</span>
0583         <span class="keyword">if</span> sim == 2
0584             disp(<span class="string">'output is averaged'</span>);
0585         <span class="keyword">end</span>
0586     <span class="keyword">end</span>
0587     xh_vec((sim-1)*N+1:sim*N,1) = xh(1:N);
0588     xh_vec((sim-1)*N+1:sim*N,2) = x_sparsa(1:N);
0589     xh_vec((sim-1)*N+1:sim*N,3) = x_yall1(1:N);
0590     
0591     
0592     s_ind = t_ind(1:L);
0593     sig_vec(s_ind) = sigt(1:L);
0594     sigh_vec(s_ind,1) = sigh_vec(s_ind,1)+Psi*xh(1:N);
0595     sigh_vec(s_ind,2) = sigh_vec(s_ind,2)+Psi*x_sparsa(1:N);
0596     sigh_vec(s_ind,3) = sigh_vec(s_ind,3)+Psi*x_yall1(1:N);
0597 
0598     
0599     
0600     <span class="comment">%% plot recovered signals</span>
0601     <a href="../L1_homotopy_v2.0/utils/fig.html" class="code" title="function h = fig(varargin)">fig</a>(1); subplot(212)
0602     plot([sig_vec(1:s_ind(end)) sigh_vec(1:s_ind(end),1)]);
0603  
0604     drawnow;
0605 <span class="keyword">end</span>
0606 
0607 mS =  sum(cell2mat(SIM_stack),1);
0608 fprintf(<span class="string">'Summed results: streaming_iter %d. tau = %3.4g, \n solver-(err,iter,time): \n streamingRWT homotopy-%3.4g,%3.4g,%3.4g; \n SpaRSA-%3.4g,%3.4g,%3.4g; \n YALL1-%3.4g,%3.4g,%3.4g. \n'</span>, streaming_iter, mS(2:end));
0609 mS =  mean(cell2mat(SIM_stack),1);
0610 fprintf(<span class="string">'Average results: streaming_iter %d. tau = %3.4g, \n solver-(err,iter,time): \n streamingRWT homotopy-%3.4g,%3.4g,%3.4g; \n SpaRSA-%3.4g,%3.4g,%3.4g; \n YALL1-%3.4g,%3.4g,%3.4g. \n'</span>, streaming_iter, mS(2:end));
0611 
0612 <span class="comment">% l1homotopy-%3.4g,%3.4g,%3.4g;</span>
0613 st_ind = 2*N;
0614 err_l1homotopy = norm(sig_vec(st_ind+1:N*sim)-sigh_vec(st_ind+1:N*sim,1))^2/norm(sig_vec(st_ind+1:N*sim))^2;
0615 err_sparsa = norm(sig_vec(st_ind+1:N*sim)-sigh_vec(st_ind+1:N*sim,2))^2/norm(sig_vec(st_ind+1:N*sim))^2;
0616 err_yall1 = norm(sig_vec(st_ind+1:N*sim)-sigh_vec(st_ind+1:N*sim,3))^2/norm(sig_vec(st_ind+1:N*sim))^2;
0617 <span class="comment">% err_l1homotopy = norm(sig_vec(L-N+1:N*sim)-sigh_vec(L-N+1:N*sim,1))^2/norm(sig_vec(L-N+1:N*sim))^2;</span>
0618 <span class="comment">% err_sparsa = norm(sig_vec(L-N+1:N*sim)-sigh_vec(L-N+1:N*sim,2))^2/norm(sig_vec(L-N+1:N*sim))^2;</span>
0619 <span class="comment">% err_yall1 = norm(sig_vec(L-N+1:N*sim)-sigh_vec(L-N+1:N*sim,3))^2/norm(sig_vec(L-N+1:N*sim))^2;</span>
0620 <span class="comment">% fprintf('Signal error: l1homotopy-%3.4g, sparsa-%3.4g, yall1-%3.4g.\n',err_l1homotopy,err_sparsa,err_yall1);</span>
0621 fprintf(<span class="string">'Signal MSE: l1homotopy-%3.4g, sparsa-%3.4g, yall1-%3.4g.\n'</span>,([err_l1homotopy,err_sparsa,err_yall1]));
0622 fprintf(<span class="string">'Signal SER (in dB): l1homotopy-%3.4g, sparsa-%3.4g, yall1-%3.4g.\n'</span>,-10*log10([err_l1homotopy,err_sparsa,err_yall1]));
0623 
0624 
0625 
0626 <span class="comment">%% plot signal and reconstruction error</span>
0627 x_len = min(length(x_vec),length(xh_vec))-(P-1)*N;
0628 sig_len = min(length(sig_vec),length(sigh_vec))-(P-1)*N-L-N;
0629 x_vec1 = x_vec(1:x_len);
0630 xh_vec1 = xh_vec(1:x_len,1);
0631 sig_vec1 = sig_vec(1:sig_len);
0632 sigh_vec1 = sigh_vec(1:sig_len,1);
0633 
0634 <a href="../L1_homotopy_v2.0/utils/fig.html" class="code" title="function h = fig(varargin)">fig</a>(123); 
0635 subplot(221); 
0636 plot((1:sig_len)/N,sig_vec1, <span class="string">'LineWidth'</span>,1);
0637 axis tight;
0638 title(<span class="string">'original signal'</span>)
0639 subplot(2,2,2)
0640 plot((1:sig_len)/N,sigh_vec1-sig_vec1, <span class="string">'LineWidth'</span>,1);
0641 axis tight
0642 title(<span class="string">'reconstruction error'</span>)
0643 subplot(2,2,3); 
0644 imagesc(reshape(x_vec1,N,x_len/N)); axis xy;
0645 axis tight;
0646 title(<span class="string">'DWT coefficients'</span>);
0647 colorbar 
0648 subplot(2,2,4); 
0649 imagesc(reshape(x_vec1-xh_vec1,N,x_len/N),[0 max(abs(x_vec1))/20]); axis xy
0650 axis tight
0651 title(<span class="string">'reconstruction error (DWT)'</span>);
0652 colorbar
0653 
0654         
0655 <a href="../L1_homotopy_v2.0/utils/fig.html" class="code" title="function h = fig(varargin)">fig</a>(3);
0656 <span class="comment">% view DWT coefficients...</span>
0657 alpha_vec1 = <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/apply_DWT.html" class="code" title="function alpha = apply_DWT(x,varargin)">apply_DWT</a>(sig_vec1,N,wType,J,sym);
0658 alphah_vec1 = <a href="../L1_homotopy_v2.0/utils/utils_Wavelet/apply_DWT.html" class="code" title="function alpha = apply_DWT(x,varargin)">apply_DWT</a>(sigh_vec1,N,wType,J,sym);
0659 subplot(221); imagesc(reshape(alpha_vec1,N,length(alpha_vec1)/N));
0660 axis xy;
0661 title(<span class="string">'original'</span>)
0662 subplot(222); imagesc(reshape(alphah_vec1,N,length(alpha_vec1)/N));
0663 axis xy;
0664 title(<span class="string">'reconstructed'</span>);
0665 subplot(212); plot([alpha_vec1 alphah_vec1]); 
0666 title(<span class="string">'comparison'</span>);</pre></div>
<hr><address>Generated on Sun 09-Jun-2013 02:08:02 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>